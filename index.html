<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Centre apps Launcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .btn-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5), 0 0 5px rgba(59, 130, 246, 0.4); }
        .game-logo-active { outline: 2px solid #3b82f6; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="launcher" class="flex h-screen w-screen">
        <aside class="w-24 bg-gray-900/80 backdrop-blur-sm p-4 flex flex-col items-center space-y-6 border-r border-gray-700/50">
            <div class="text-blue-500 font-black text-2xl">VRC</div>
            <nav id="game-list" class="flex flex-col items-center space-y-4"></nav>
        </aside>

        <main class="flex-1 relative">
            <div class="absolute inset-0 w-full h-full z-0">
                <img id="game-background" src="" class="w-full h-full object-cover transition-opacity duration-1000" alt="Game Background">
                <div class="absolute inset-0 bg-black/60"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-gray-900 to-transparent"></div>
            </div>
            <div class="relative z-10 flex flex-col h-full p-8 md:p-12">
                <header class="flex justify-between items-center">
                     <div class="flex items-center space-x-6 text-gray-300">
                        <a href="#" class="hover:text-white transition-colors duration-200 font-semibold">NEWS</a>
                        <a href="#" class="hover:text-white transition-colors duration-200">COMMUNITY</a>
                        <a href="#" class="hover:text-white transition-colors duration-200">STORE</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium">PlayerOne</span>
                        <img src="https://placehold.co/40x40/1f2937/ffffff?text=P" class="rounded-full w-10 h-10 border-2 border-gray-600">
                    </div>
                </header>
                <div class="flex-grow flex items-end">
                    <div class="w-full">
                        <h1 id="game-title" class="text-5xl md:text-7xl font-black uppercase tracking-wider transition-opacity duration-500"></h1>
                        <p id="game-tagline" class="text-gray-400 mt-2 text-lg"></p>
                        <div class="mt-8 flex items-center space-x-6">
                            <button id="action-button" class="px-12 py-4 text-xl font-bold rounded-lg transition-all duration-300 flex items-center justify-center min-w-[200px]"></button>
                            <div id="download-controls" class="hidden items-center space-x-4">
                                <button id="pause-resume-button" class="px-6 py-4 text-lg font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-all duration-300">Pause</button>
                                <button id="cancel-button" class="px-6 py-4 text-lg font-bold rounded-lg bg-red-600 hover:bg-red-700 transition-all duration-300">Cancel</button>
                            </div>
                            <button id="settings-button" class="hidden p-4 rounded-lg bg-gray-600/50 hover:bg-gray-700/50 transition-colors duration-300" title="Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                            <button id="uninstall-button" class="hidden p-4 rounded-lg bg-red-800/50 hover:bg-red-700/50 transition-colors duration-300" title="Uninstall Game">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                             <button id="check-update-button" class="hidden p-4 rounded-lg bg-blue-800/50 hover:bg-blue-700/50 transition-colors duration-300" title="Check for Updates">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.549 10.214a.75.75 0 01.902 1.06l-4.5 4.25a.75.75 0 01-1.012-.064l-4.25-4.5a.75.75 0 111.124-.99l3.438 3.654 3.998-3.754a.75.75 0 011.06-.06z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M4.451 9.786a.75.75 0 01-.902-1.06l4.5-4.25a.75.75 0 011.012.064l4.25 4.5a.75.75 0 11-1.124.99L8.75 6.346l-3.998 3.754a.75.75 0 01-1.06.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="text-sm text-gray-500">
                                <div>Version <span id="game-version"></span></div>
                                <div id="game-status-text"></div>
                            </div>
                        </div>
                        <div id="progress-container" class="mt-4 w-full max-w-lg hidden">
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-100" style="width: 0%"></div>
                            </div>
                            <div id="progress-text" class="mt-2 text-sm text-gray-400"></div>
                        </div>
                        <div id="locate-game-container" class="mt-4 hidden">
                            <a href="#" id="locate-game-link" class="text-sm text-blue-400 hover:underline">Already Installed? Locate the game folder.</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="close-settings-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-2">Installation Path</h3>
                <div class="flex items-center space-x-4">
                    <input type="text" id="install-path-display" class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full" readonly>
                    <button id="change-path-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Change</button>
                </div>
                <p class="text-sm text-gray-400 mt-2">This is where the game files are currently located.</p>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let gameLibrary = {
                'VRClassroom': {
                    name: 'VR Classroom',
                    tagline: 'The future of immersive learning.',
                    version: '0.0.0',
                    status: 'uninstalled',
                    logoUrl: 'https://vrcentre.com.au/wp-content/uploads/2021/06/cropped-favicon-Master.png',
                    backgroundUrl: 'https://vrcentre.com.au/wp-content/uploads/2021/06/cropped-Primary_Logo_Horizontal_Web-01-1.png',
                    installPath: null,
                    executable: 'VRClassroom.exe',
                    manifestUrl: 'https://mediumblue-swallow-996105.hostingersite.com/launcher_files/vrclassroom/vrclassroom_manifest.json',
                    versionUrl: 'https://mediumblue-swallow-996105.hostingersite.com/launcher_files/vrclassroom/version.json',
                    filesToUpdate: [],
                    isPaused: false,
                },
            };

            let currentGameId = 'VRClassroom';

            // --- DOM Elements ---
            const gameListEl = document.getElementById('game-list'),
                  gameBgEl = document.getElementById('game-background'),
                  gameTitleEl = document.getElementById('game-title'),
                  gameTaglineEl = document.getElementById('game-tagline'),
                  gameVersionEl = document.getElementById('game-version'),
                  gameStatusTextEl = document.getElementById('game-status-text'),
                  actionButtonEl = document.getElementById('action-button'),
                  downloadControlsEl = document.getElementById('download-controls'),
                  pauseResumeButtonEl = document.getElementById('pause-resume-button'),
                  cancelButtonEl = document.getElementById('cancel-button'),
                  settingsButtonEl = document.getElementById('settings-button'),
                  uninstallButtonEl = document.getElementById('uninstall-button'),
                  checkUpdateButtonEl = document.getElementById('check-update-button'),
                  progressContainerEl = document.getElementById('progress-container'),
                  progressBarEl = document.getElementById('progress-bar'),
                  progressTextEl = document.getElementById('progress-text'),
                  locateGameContainerEl = document.getElementById('locate-game-container'),
                  settingsModalEl = document.getElementById('settings-modal'),
                  closeSettingsButtonEl = document.getElementById('close-settings-button'),
                  installPathDisplayEl = document.getElementById('install-path-display'),
                  changePathButtonEl = document.getElementById('change-path-button'),
                  locateGameLinkEl = document.getElementById('locate-game-link');

            function formatBytes(bytes, decimals = 2) {
                if (!bytes || bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function renderGame(gameId) {
                const game = gameLibrary[gameId];
                if (!game) return;
                gameBgEl.style.opacity = '0';
                setTimeout(() => {
                    gameBgEl.src = game.backgroundUrl;
                    gameBgEl.onload = () => { gameBgEl.style.opacity = '1'; };
                }, 500);
                gameTitleEl.innerText = game.name;
                gameTaglineEl.innerText = game.tagline;
                gameVersionEl.innerText = game.version;
                updateButtonAndStatus(game);
                document.querySelectorAll('.game-logo').forEach(logo => {
                    logo.classList.toggle('game-logo-active', logo.dataset.gameId === gameId);
                });
            }
            
            function updateButtonAndStatus(game) {
                actionButtonEl.className = 'px-12 py-4 text-xl font-bold rounded-lg transition-all duration-300 flex items-center justify-center min-w-[200px]';
                actionButtonEl.disabled = false;
                actionButtonEl.classList.remove('hidden');
                downloadControlsEl.classList.add('hidden');
                settingsButtonEl.classList.add('hidden');
                uninstallButtonEl.classList.add('hidden');
                checkUpdateButtonEl.classList.add('hidden');
                progressContainerEl.style.display = 'none';
                locateGameContainerEl.classList.add('hidden');
                
                switch (game.status) {
                    case 'installed':
                        actionButtonEl.innerText = 'LAUNCH';
                        actionButtonEl.classList.add('bg-green-500', 'hover:bg-green-600', 'btn-glow');
                        gameStatusTextEl.innerText = 'Ready to Play';
                        settingsButtonEl.classList.remove('hidden');
                        uninstallButtonEl.classList.remove('hidden');
                        checkUpdateButtonEl.classList.remove('hidden');
                        break;
                    case 'needs_update':
                        actionButtonEl.innerText = 'UPDATE';
                        actionButtonEl.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        gameStatusTextEl.innerText = `Update available!`;
                        settingsButtonEl.classList.remove('hidden');
                        uninstallButtonEl.classList.remove('hidden');
                        break;
                    case 'uninstalled':
                        actionButtonEl.innerText = 'INSTALL';
                        actionButtonEl.classList.add('bg-blue-500', 'hover:bg-blue-600', 'btn-glow');
                        gameStatusTextEl.innerText = 'Not Installed';
                        locateGameContainerEl.classList.remove('hidden');
                        break;
                    case 'verifying':
                        actionButtonEl.disabled = true;
                        actionButtonEl.innerText = 'VERIFYING...';
                        actionButtonEl.classList.add('bg-gray-500', 'cursor-not-allowed');
                        gameStatusTextEl.innerText = 'Verifying game files...';
                        break;
                    case 'moving':
                        actionButtonEl.disabled = true;
                        actionButtonEl.innerText = 'MOVING...';
                        actionButtonEl.classList.add('bg-gray-500', 'cursor-not-allowed');
                        gameStatusTextEl.innerText = 'Moving game files to a new location...';
                        settingsButtonEl.classList.add('hidden');
                        uninstallButtonEl.classList.add('hidden');
                        checkUpdateButtonEl.classList.add('hidden');
                        break;
                    case 'checking_update':
                        actionButtonEl.disabled = true;
                        actionButtonEl.innerText = 'Please wait...';
                        actionButtonEl.classList.add('bg-gray-500', 'cursor-not-allowed');
                        gameStatusTextEl.innerText = 'Checking for updates...';
                        settingsButtonEl.classList.remove('hidden');
                        uninstallButtonEl.classList.remove('hidden');
                        break;
                    case 'downloading':
                    case 'paused':
                        actionButtonEl.classList.add('hidden');
                        downloadControlsEl.classList.remove('hidden');
                        progressContainerEl.style.display = 'block';
                        break;
                }
            }

            function openSettingsModal() {
                const game = gameLibrary[currentGameId];
                installPathDisplayEl.value = game.installPath || 'Not Set';
                settingsModalEl.classList.remove('hidden');
            }

            function closeSettingsModal() {
                settingsModalEl.classList.add('hidden');
            }
            
            async function handleActionButtonClick() {
                const game = gameLibrary[currentGameId];
                
                switch (game.status) {
                    case 'uninstalled':
                        const selectedPath = await window.electronAPI.selectInstallDir();
                        if (selectedPath) {
                            game.installPath = selectedPath;
                            await window.electronAPI.saveGameData(gameLibrary);
                            await checkForUpdates(currentGameId);
                        }
                        break;
                    case 'needs_update':
                         window.electronAPI.handleDownloadAction({
                             type: 'START',
                             payload: {
                                gameId: currentGameId,
                                installPath: game.installPath,
                                files: game.filesToUpdate,
                                latestVersion: game.version,
                             }
                         });
                        break;
                    case 'installed':
                        window.electronAPI.launchGame({ installPath: game.installPath, executable: game.executable });
                        actionButtonEl.innerText = 'LAUNCHING...';
                        setTimeout(() => renderGame(currentGameId), 1000);
                        break;
                }
            }

            function handlePauseResumeClick() {
                const game = gameLibrary[currentGameId];
                if (game.status === 'downloading') {
                    window.electronAPI.handleDownloadAction({ type: 'PAUSE' });
                } else if (game.status === 'paused') {
                    window.electronAPI.handleDownloadAction({ type: 'RESUME' });
                }
            }

            async function checkForUpdates(gameId) {
                const game = gameLibrary[gameId];
                if (!game.installPath && game.status !== 'uninstalled') {
                    game.status = 'uninstalled';
                    renderGame(gameId);
                    return;
                }
                
                game.status = 'checking_update';
                renderGame(gameId);

                const result = await window.electronAPI.checkForUpdates({ gameId, installPath: game.installPath, manifestUrl: game.manifestUrl });
                if (result.error) {
                    game.status = 'installed';
                    gameStatusTextEl.innerText = result.error;
                } else if (result.isUpdateAvailable) {
                    game.status = 'needs_update';
                    game.filesToUpdate = result.filesToUpdate;
                    game.version = result.latestVersion;
                } else {
                    game.status = 'installed';
                    game.version = result.latestVersion;
                }
                window.electronAPI.saveGameData(gameLibrary);
                renderGame(gameId);
            }

            async function init() {
                if (!window.electronAPI) { console.error("Fatal Error: window.electronAPI is not defined."); return; }
                const loadedLibrary = await window.electronAPI.loadGameData();
                if (loadedLibrary) {
                    for (const gameId in gameLibrary) {
                        if (loadedLibrary[gameId]) {
                            gameLibrary[gameId] = { ...gameLibrary[gameId], ...loadedLibrary[gameId] };
                        }
                    }
                }

                for (const gameId in gameLibrary) {
                    const game = gameLibrary[gameId];
                    if (game.installPath && (game.status === 'installed' || game.status === 'needs_update')) {
                        const localVersion = await window.electronAPI.getLocalVersion(game.installPath);
                        game.version = localVersion;
                    }
                }

                gameListEl.innerHTML = '';
                for (const gameId in gameLibrary) {
                    const game = gameLibrary[gameId];
                    const logoEl = document.createElement('img');
                    logoEl.src = game.logoUrl;
                    logoEl.alt = `${game.name} Logo`;
                    logoEl.className = 'w-16 h-16 rounded-lg cursor-pointer transition-all duration-200 hover:scale-110 game-logo';
                    logoEl.dataset.gameId = gameId;
                    logoEl.addEventListener('click', () => {
                       if (gameLibrary[currentGameId].status !== 'downloading' && gameLibrary[currentGameId].status !== 'paused') {
                           currentGameId = gameId;
                           renderGame(gameId);
                       }
                    });
                    gameListEl.appendChild(logoEl);
                }
                actionButtonEl.addEventListener('click', handleActionButtonClick);
                pauseResumeButtonEl.addEventListener('click', handlePauseResumeClick);
                cancelButtonEl.addEventListener('click', () => window.electronAPI.handleDownloadAction({ type: 'CANCEL' }));
                
                settingsButtonEl.addEventListener('click', openSettingsModal);
                closeSettingsButtonEl.addEventListener('click', closeSettingsModal);

                uninstallButtonEl.addEventListener('click', () => {
                    const game = gameLibrary[currentGameId];
                    if (game.installPath) {
                        window.electronAPI.uninstallGame(game.installPath);
                    }
                });

                checkUpdateButtonEl.addEventListener('click', () => checkForUpdates(currentGameId));

                changePathButtonEl.addEventListener('click', async () => {
                    const game = gameLibrary[currentGameId];
                    if (!game.installPath) return;

                    game.status = 'moving';
                    renderGame(currentGameId);
                    closeSettingsModal();

                    const newPath = await window.electronAPI.moveInstallPath(game.installPath);
                    if (newPath) {
                        game.installPath = newPath;
                        await window.electronAPI.saveGameData(gameLibrary);
                        game.status = 'installed';
                        renderGame(currentGameId);
                    } else {
                        game.status = 'installed';
                        renderGame(currentGameId);
                        alert('Move Failed: The folder could not be moved. Please check permissions and try again.');
                    }
                });

                locateGameLinkEl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const game = gameLibrary[currentGameId];
                    
                    game.status = 'verifying';
                    renderGame(currentGameId);

                    const result = await window.electronAPI.verifyInstallPath({ gameId: currentGameId, manifestUrl: game.manifestUrl });
                    
                    if (result.isValid) {
                        game.installPath = result.path;
                        game.version = result.localVersion;
                        game.status = 'installed';
                        await window.electronAPI.saveGameData(gameLibrary);
                        renderGame(currentGameId);
                        await checkForUpdates(currentGameId);
                    } else {
                        game.status = 'uninstalled';
                        renderGame(currentGameId);
                        gameStatusTextEl.innerText = result.error || "Could not validate the selected folder.";
                    }
                });

                window.electronAPI.onDownloadStateUpdate((state) => {
                    const game = gameLibrary[currentGameId];
                    game.status = state.status;
                    renderGame(currentGameId);

                    switch (state.status) {
                        case 'downloading':
                            progressBarEl.style.width = `${state.progress.toFixed(2)}%`;
                            progressTextEl.innerText = `Downloading: ${state.currentFileName} (${formatBytes(state.downloadedBytes)} / ${formatBytes(state.totalBytes)})`;
                            gameStatusTextEl.innerText = `Downloading update... (${state.filesDownloaded}/${state.totalFiles})`;
                            pauseResumeButtonEl.innerText = 'Pause';
                            break;
                        case 'paused':
                            gameStatusTextEl.innerText = 'Download paused.';
                            pauseResumeButtonEl.innerText = 'Resume';
                            break;
                        case 'success':
                            game.status = 'installed';
                            game.filesToUpdate = [];
                            window.electronAPI.saveGameData(gameLibrary);
                            renderGame(currentGameId);
                            break;
                        case 'error':
                            game.status = 'needs_update'; // Or 'uninstalled' depending on previous state
                            renderGame(currentGameId);
                            gameStatusTextEl.innerText = `Error: ${state.error}`;
                            break;
                        case 'idle':
                            game.status = 'uninstalled'; // Or needs_update
                            renderGame(currentGameId);
                            break;
                    }
                });

                window.electronAPI.onUninstallComplete(() => {
                    const game = gameLibrary[currentGameId];
                    game.status = 'uninstalled';
                    game.installPath = null;
                    game.version = '0.0.0';
                    window.electronAPI.saveGameData(gameLibrary);
                    renderGame(currentGameId);
                });

                window.electronAPI.onMoveProgress((data) => {
                    gameStatusTextEl.innerText = `Moving: ${data.file} (${data.progress.toFixed(0)}%)`;
                });

                renderGame(currentGameId);
                for (const gameId in gameLibrary) {
                    const game = gameLibrary[gameId];
                    if (game.installPath && game.status !== 'uninstalled') {
                        const versionResult = await window.electronAPI.checkForUpdates({
                            gameId: gameId,
                            installPath: game.installPath,
                            manifestUrl: game.manifestUrl
                        });
                        if (versionResult.isUpdateAvailable) {
                            game.status = 'needs_update';
                            game.version = versionResult.latestVersion;
                            game.filesToUpdate = versionResult.filesToUpdate;
                        } else {
                            game.status = 'installed';
                            game.version = versionResult.latestVersion;
                        }
                        renderGame(gameId);
                    }
                }
            }

            init();
        });
    </script>
</body>
</html>
